@{
    ViewData["Title"] = "Relatório por Categoria";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="ft-page-container">

    <h2 class="fw-bold text-white mb-3">Agrupamento por Categoria</h2>
    <p class="text-secondary mb-4">Total por categoria no período selecionado.</p>

    <div class="ft-card p-4 mb-4">

        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label text-white-50">Data Início</label>
                <input type="date" id="dataInicio" class="form-control flatpickr" />
            </div>

            <div class="col-md-4">
                <label class="form-label text-white-50">Data Fim</label>
                <input type="date" id="dataFim" class="form-control flatpickr" />
            </div>

            <div class="col-md-4 d-flex align-items-end">
                <button id="btnFiltrar" class="btn btn-warning w-100 fw-bold" style="border-radius:10px;">
                    Buscar
                </button>
            </div>
        </div>
    </div>

    <div class="ft-card p-4">
        <div class="table-responsive">
            <table id="tabelaCategorias" class="table table-dark table-hover align-middle mb-0">
                <thead>
                    <tr class="text-warning">
                        <th>Categoria</th>
                        <th>Total</th>
                        <th>%</th>
                    </tr>
                </thead>
                <tbody id="tbodyCategorias">
                    <tr>
                        <td colspan="3" class="text-center text-muted py-4">
                            Escolha um intervalo de datas e clique em Buscar.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

@section Scripts {
    <script>
        document.getElementById("btnFiltrar").addEventListener("click", function () {

            let inicio = document.getElementById("dataInicio").value;
            let fim = document.getElementById("dataFim").value;

            if (!inicio || !fim) {
                alert("Selecione as duas datas.");
                return;
            }

            let url = `/Relatorios/CategoriasJson?inicio=${inicio}&fim=${fim}`;
            fetch(url)
                .then(res => res.json())
                .then(dados => atualizarTabela(dados))
                .catch(err => console.error(err));
        });

        function atualizarTabela(lista) {

            const tbody = document.getElementById("tbodyCategorias");
            tbody.innerHTML = "";

            if (!lista || lista.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-muted py-4">
                            Nenhum dado encontrado.
                        </td>
                    </tr>`;
                return;
            }

            const totalGeral = lista.reduce((acc, x) => acc + x.total, 0);

            lista.forEach(item => {
                let porcentagem = totalGeral > 0
                    ? ((item.total / totalGeral) * 100).toFixed(1)
                    : 0;

                tbody.innerHTML += `
                    <tr>
                        <td class="fw-bold">${item.categoria}</td>
                        <td>${item.total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                        <td>${porcentagem}%</td>
                    </tr>`;
            });
        }
    </script>
}

<style>
    .ft-card {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 16px;
        backdrop-filter: blur(12px);
        padding: 24px;
    }

    .ft-main-content {
        background: #1e1e1e !important;
        padding: 40px !important;
        min-height: 100vh;
    }

    .ft-page-container {
        max-width: 1100px;
        margin: 0 auto;
    }
</style>
