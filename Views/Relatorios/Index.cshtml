@{
    ViewData["Title"] = "Relatórios";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="ft-page-container">
    <h2 class="fw-bold text-white mb-3">Relatórios</h2>
    <p class="text-secondary mb-4">Visualize seus gráficos financeiros.</p>

    <div class="ft-card p-4 mb-4">

        <div class="row g-4">

            <div class="col-lg-8">
                <h5 class="text-white-50 mb-3">Receitas x Despesas (por mês)</h5>
                <canvas id="monthlyChart" height="130"></canvas>
            </div>

            <div class="col-lg-4">
                <h5 class="text-white-50 mb-3">Por categoria (mês selecionado)</h5>

                <select id="monthSelect" class="form-select mb-3">
                    @for (int m = 1; m <= 12; m++)
                    {
                        <option value="@m">
                            @System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetAbbreviatedMonthName(m)
                        </option>
                    }
                </select>

                <select id="yearSelect" class="form-select mb-3">
                    @{
                        var yearNow = DateTime.Now.Year;
                        for (int y = yearNow; y >= yearNow - 2; y--)
                        {
                            <option value="@y">@y</option>
                        }
                    }
                </select>

                <canvas id="categoryChart" height="260"></canvas>
            </div>

        </div>

    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
        const categoryCtx = document.getElementById('categoryChart').getContext('2d');

        let monthlyChart = null;
        let categoryChart = null;

        function createMonthlyChart(labels, entradas, saidas) {
            if (monthlyChart) monthlyChart.destroy();
            monthlyChart = new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'Entradas', data: entradas, backgroundColor: 'rgba(60,255,120,0.8)', stack: 'stack1' },
                        { label: 'Saídas', data: saidas, backgroundColor: 'rgba(255,80,80,0.8)', stack: 'stack1' }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => value.toLocaleString('pt-BR', {
                                    style: 'currency',
                                    currency: 'BRL'
                                })
                            }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: "#fff" } },
                        tooltip: {
                            callbacks: {
                                label: ctx => ctx.raw.toLocaleString('pt-BR', {
                                    style: 'currency',
                                    currency: 'BRL'
                                })
                            }
                        }
                    }
                }
            });
        }

        function createCategoryChart(labels, data) {
            if (categoryChart) categoryChart.destroy();
            categoryChart = new Chart(categoryCtx, {
                type: 'pie',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: [
                            '#ffd700', '#f5c400', '#e0af00', '#cc9c00',
                            '#b88900', '#a67600', '#946300', '#825000'
                        ]
                    }]
                },
                options: {
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.label}: ${ctx.raw.toLocaleString('pt-BR', {
                                    style: 'currency',
                                    currency: 'BRL'
                                })}`
                            }
                        },
                        legend: { labels: { color: "#fff" } }
                    }
                }
            });
        }

        async function loadMonthly(year) {
            const res = await fetch(`/Relatorios/MonthlyTotalsJson?year=${year}`);
            const data = await res.json();
            const labels = data.map(d =>
                new Date(0, d.month - 1).toLocaleString('pt-BR', { month: 'short' })
            );
            createMonthlyChart(
                labels,
                data.map(d => Number(d.entrada)),
                data.map(d => Number(d.saida))
            );
        }

        async function loadCategory(year, month) {
            const res = await fetch(`/Relatorios/CategoryTotalsJson?year=${year}&month=${month}`);
            const data = await res.json();
            createCategoryChart(
                data.map(d => d.categoria),
                data.map(d => Number(d.total))
            );
        }

        document.addEventListener("DOMContentLoaded", () => {
            const yearNow = new Date().getFullYear();
            const monthNow = new Date().getMonth() + 1;

            document.getElementById("yearSelect").value = yearNow;
            document.getElementById("monthSelect").value = monthNow;

            loadMonthly(yearNow);
            loadCategory(yearNow, monthNow);

            document.getElementById("monthSelect").addEventListener("change", () => {
                loadCategory(
                    document.getElementById("yearSelect").value,
                    document.getElementById("monthSelect").value
                );
            });

            document.getElementById("yearSelect").addEventListener("change", () => {
                loadMonthly(document.getElementById("yearSelect").value);
                loadCategory(
                    document.getElementById("yearSelect").value,
                    document.getElementById("monthSelect").value
                );
            });
        });
    </script>
}

<style>
    .ft-page-container {
        max-width: 1100px;
        margin: 0 auto;
    }

    .ft-card {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 16px;
        backdrop-filter: blur(12px);
    }

    .ft-main-content {
        background: #1e1e1e !important;
        padding: 40px !important;
        min-height: 100vh;
    }
</style>
